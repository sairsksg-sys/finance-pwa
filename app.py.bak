from flask import Flask, render_template, request, redirect, send_file, url_for
from flask_login import LoginManager, UserMixin, login_user, login_required, logout_user
from werkzeug.security import check_password_hash
import sqlite3
import pandas as pd
from datetime import datetime
from apscheduler.schedulers.background import BackgroundScheduler
from reportlab.pdfgen import canvas
import os
from datetime import date

# --------------------
# App setup
# --------------------
app = Flask(__name__)
app.secret_key = "supersecretkey"

login_manager = LoginManager(app)
login_manager.login_view = "login"

# --------------------
# Database helper
# --------------------
def db():
    con = sqlite3.connect("finance.db")
    con.row_factory = sqlite3.Row
    return con

# --------------------
# Login
# --------------------
class User(UserMixin):
    def __init__(self, id):
        self.id = id

@login_manager.user_loader
def load_user(id):
    return User(id)

@app.route("/login", methods=["GET", "POST"])
def login():
    if request.method == "POST":
        con = db()
        user = con.execute(
            "SELECT id, password FROM users WHERE email=?",
            (request.form["email"],)
        ).fetchone()

        if user and check_password_hash(user["password"], request.form["password"]):
            login_user(User(user["id"]))
            return redirect("/")

        return "Invalid credentials"

    return render_template("login.html")

@app.route("/logout")
def logout():
    logout_user()
    return redirect("/login")

# --------------------
# Utilities
# --------------------
def compound_interest(p, r, start, end):
    if not r or not end:
        return p
    years = (datetime.strptime(end, "%Y-%m-%d") -
             datetime.strptime(start, "%Y-%m-%d")).days / 365
    return round(p * ((1 + r / 100) ** years), 2)

# --------------------
# Home
# --------------------
@app.route("/")
def home():
    return render_template("home.html")

# ==========================================================
# EXPENSES CRUD
# ==========================================================
@app.route("/expenses", methods=["GET", "POST"])
def expenses():
    con = db()

    if request.method == "POST":
        con.execute("""
            INSERT INTO expenses
            (title, description, date, country, currency, mode, amount)
            VALUES (?, ?, ?, ?, ?, ?, ?)
        """, (
            request.form["title"],
            request.form["description"],
            request.form["date"],
            request.form["country"],
            request.form["currency"],
            request.form["mode"],
            request.form["amount"]
        ))
        con.commit()
        return redirect("/expenses")

    rows = con.execute("SELECT * FROM expenses ORDER BY date DESC").fetchall()
    return render_template("expenses.html", expenses=rows)

@app.route("/expenses/edit/<int:id>", methods=["GET", "POST"])
def edit_expense(id):
    con = db()

    if request.method == "POST":
        con.execute("""
            UPDATE expenses SET
                title=?, description=?, date=?, country=?, currency=?, mode=?, amount=?
            WHERE id=?
        """, (
            request.form["title"],
            request.form["description"],
            request.form["date"],
            request.form["country"],
            request.form["currency"],
            request.form["mode"],
            request.form["amount"],
            id
        ))
        con.commit()
        return redirect("/expenses")

    expense = con.execute("SELECT * FROM expenses WHERE id=?", (id,)).fetchone()
    return render_template("edit_expense.html", expense=expense)

@app.route("/expenses/delete/<int:id>")
def delete_expense(id):
    con = db()
    con.execute("DELETE FROM expenses WHERE id=?", (id,))
    con.commit()
    return redirect("/expenses")

# ==========================================================
# INVESTMENTS CRUD
# ==========================================================
# --- List investments ---
@app.route("/investments")
def investments():
    con = db()
    rows = con.execute("SELECT * FROM investments ORDER BY invest_date DESC").fetchall()
    return render_template("investments.html", investments=rows, edit_investment=None)

# --- Add investment ---
@app.route("/investments/add", methods=["POST"])
def add_investment():
    con = db()
    maturity = compound_interest(float(request.form["principal"]),
                                float(request.form.get("interest", 0)),
                                request.form["invest_date"],
                                request.form.get("maturity_date"))
    con.execute("""INSERT INTO investments
                   (instrument,instrument_other,title,description,country,currency,
                    invest_date,maturity_date,principal,interest,maturity_value)
                   VALUES (?,?,?,?,?,?,?,?,?,?,?)""",
                (request.form["instrument"], request.form.get("instrument_other"),
                 request.form["title"], request.form["description"],
                 request.form["country"], request.form["currency"],
                 request.form["invest_date"], request.form.get("maturity_date"),
                 request.form["principal"], request.form.get("interest"), maturity))
    con.commit()
    return redirect("/investments")

# --- Edit investment ---
@app.route("/investments/<int:id>/edit")
def edit_investment(id):
    con = db()
    row = con.execute("SELECT * FROM investments WHERE id=?", (id,)).fetchone()
    rows = con.execute("SELECT * FROM investments ORDER BY invest_date DESC").fetchall()
    return render_template("investments.html", investments=rows, edit_investment=row)

# --- Update investment ---
@app.route("/investments/<int:id>/update", methods=["POST"])
def update_investment(id):
    con = db()
    maturity = compound_interest(float(request.form["principal"]),
                                float(request.form.get("interest", 0)),
                                request.form["invest_date"],
                                request.form.get("maturity_date"))
    con.execute("""UPDATE investments
                   SET instrument=?, instrument_other=?, title=?, description=?,
                       country=?, currency=?, invest_date=?, maturity_date=?,
                       principal=?, interest=?, maturity_value=?
                   WHERE id=?""",
                (request.form["instrument"], request.form.get("instrument_other"),
                 request.form["title"], request.form["description"],
                 request.form["country"], request.form["currency"],
                 request.form["invest_date"], request.form.get("maturity_date"),
                 request.form["principal"], request.form.get("interest"), maturity, id))
    con.commit()
    return redirect("/investments")

# --- Delete investment ---
@app.route("/investments/<int:id>/delete")
def delete_investment(id):
    con = db()
    con.execute("DELETE FROM investments WHERE id=?", (id,))
    con.commit()
    return redirect("/investments")


# ==========================================================
# PAYMENTS CRUD
# ==========================================================

# --- List payments ---
@app.route("/payments")
def payments():
    con = db()
    rows = con.execute("SELECT * FROM payments ORDER BY due_date ASC").fetchall()
    today = date.today().isoformat()
    return render_template("payments.html", payments=rows, edit_payment=None, today=today)

# --- Add payment ---
@app.route("/payments/add", methods=["POST"])
def add_payment():
    con = db()
    con.execute("""INSERT INTO payments
                   (title, description, country, currency, interval, due_date, mode, mode_other, 
                    reminder_value, reminder_unit, email, status)
                   VALUES (?,?,?,?,?,?,?,?,?,?,?,?)""",
                (request.form["title"], request.form.get("description"),
                 request.form["country"], request.form["currency"],
                 request.form.get("interval"), request.form["due_date"],
                 request.form["mode"], request.form.get("mode_other"),
                 request.form.get("reminder_value"), request.form.get("reminder_unit"),
                 request.form.get("email"), request.form.get("status")))
    con.commit()
    return redirect("/payments")

# --- Edit payment ---
@app.route("/payments/<int:id>/edit")
def edit_payment(id):
    con = db()
    row = con.execute("SELECT * FROM payments WHERE id=?", (id,)).fetchone()
    rows = con.execute("SELECT * FROM payments ORDER BY due_date ASC").fetchall()
    today = date.today().isoformat()
    return render_template("payments.html", payments=rows, edit_payment=row, today=today)

# --- Update payment ---
@app.route("/payments/<int:id>/update", methods=["POST"])
def update_payment(id):
    con = db()
    con.execute("""UPDATE payments
                   SET title=?, description=?, country=?, currency=?, interval=?, due_date=?,
                       mode=?, mode_other=?, reminder_value=?, reminder_unit=?, email=?, status=?
                   WHERE id=?""",
                (request.form["title"], request.form.get("description"),
                 request.form["country"], request.form["currency"],
                 request.form.get("interval"), request.form["due_date"],
                 request.form["mode"], request.form.get("mode_other"),
                 request.form.get("reminder_value"), request.form.get("reminder_unit"),
                 request.form.get("email"), request.form.get("status"), id))
    con.commit()
    return redirect("/payments")

# --- Delete payment ---
@app.route("/payments/<int:id>/delete")
def delete_payment(id):
    con = db()
    con.execute("DELETE FROM payments WHERE id=?", (id,))
    con.commit()
    return redirect("/payments")

# ==========================================================
# REPORTS
# ==========================================================
@app.route("/reports")
def reports():
    return render_template("reports.html")

@app.route("/generate-report")
def generate_report():
    entity = request.args.get("entity")
    country = request.args.get("country")
    period = request.args.get("period")
    fmt = request.args.get("format")

    df = pd.read_sql(
        f"SELECT * FROM {entity} WHERE country=?",
        db(),
        params=(country,)
    )

    if "date" in df.columns:
        df["date"] = pd.to_datetime(df["date"])
        now = datetime.now()

        if period == "monthly":
            df = df[df["date"].dt.month == now.month]
        elif period == "quarterly":
            df = df[df["date"].dt.quarter == now.quarter]
        elif period == "half-yearly":
            df = df[df["date"].dt.month <= 6]
        elif period == "annual":
            df = df[df["date"].dt.year == now.year]

    filename = f"{entity}_{country}_{period}"

    if fmt == "csv":
        path = f"{filename}.csv"
        df.to_csv(path, index=False)
    elif fmt == "excel":
        path = f"{filename}.xlsx"
        df.to_excel(path, index=False)
    else:
        path = f"{filename}.pdf"
        c = canvas.Canvas(path)
        y = 800
        for _, row in df.iterrows():
            c.drawString(40, y, str(row.to_dict()))
            y -= 20
            if y < 50:
                c.showPage()
                y = 800
        c.save()

    return send_file(path, as_attachment=True)

# ==========================================================
# EMAIL REMINDERS (DEMO)
# ==========================================================
def send_reminders():
    rows = db().execute("""
        SELECT title, email FROM payments
        WHERE due_date = date('now', '+1 day')
    """).fetchall()

    for r in rows:
        print("Reminder email:", r["title"], "to", r["email"])

scheduler = BackgroundScheduler()
scheduler.add_job(send_reminders, "interval", hours=24)
scheduler.start()

# --------------------
# Run
# --------------------
if __name__ == "__main__":
    app.run(
        host="0.0.0.0",
        port=int(os.environ.get("PORT", 8080))
    )
